<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastMarket - Teste E2E</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .test-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-step {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .test-step.running {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .test-step.success {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .test-step.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .test-step-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background: #e2e8f0;
            color: #64748b;
        }

        .status-running {
            background: #fbbf24;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-success {
            background: #10b981;
            color: white;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .test-details {
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .test-data {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: block;
            margin: 30px auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #64748b;
            font-size: 14px;
        }

        .passed { color: #10b981; }
        .failed { color: #ef4444; }
        .pending { color: #f59e0b; }
        .total { color: #667eea; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ FastMarket - Teste End-to-End</h1>
        <p class="subtitle">Valida√ß√£o de integra√ß√£o completa: Frontend ‚Üí Backend ‚Üí Banco de Dados</p>

        <div class="summary">
            <div class="summary-card">
                <div class="summary-number total" id="totalTests">0</div>
                <div class="summary-label">Total de Testes</div>
            </div>
            <div class="summary-card">
                <div class="summary-number passed" id="passedTests">0</div>
                <div class="summary-label">Aprovados ‚úì</div>
            </div>
            <div class="summary-card">
                <div class="summary-number failed" id="failedTests">0</div>
                <div class="summary-label">Falhados ‚úó</div>
            </div>
            <div class="summary-card">
                <div class="summary-number pending" id="pendingTests">0</div>
                <div class="summary-label">Pendentes ‚è≥</div>
            </div>
        </div>

        <button id="runTests" onclick="runAllTests()">‚ñ∂Ô∏è Executar Testes E2E</button>

        <div class="test-section">
            <h2>üì¶ 1. Teste de Produtos</h2>
            <div id="test-products"></div>
        </div>

        <div class="test-section">
            <h2>üë§ 2. Teste de Cadastro Fast+</h2>
            <div id="test-fastplus"></div>
        </div>

        <div class="test-section">
            <h2>üõí 3. Teste de Carrinho e Venda</h2>
            <div id="test-sale"></div>
        </div>

        <div class="test-section">
            <h2>üîç 4. Valida√ß√£o no Banco de Dados</h2>
            <div id="test-database"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';
        let testStats = { total: 0, passed: 0, failed: 0, pending: 0 };
        let createdFastPlusId = null;
        let createdFastPlusCpf = null;
        let createdSaleId = null;

        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('pendingTests').textContent = testStats.pending;
        }

        function createTestStep(container, name, description) {
            const step = document.createElement('div');
            step.className = 'test-step';
            step.innerHTML = `
                <div class="test-step-header">
                    <div class="status-icon status-pending">‚è≥</div>
                    <strong>${name}</strong>
                </div>
                <div style="color: #64748b; font-size: 14px;">${description}</div>
            `;
            document.getElementById(container).appendChild(step);
            testStats.total++;
            testStats.pending++;
            updateStats();
            return step;
        }

        function updateTestStep(step, status, details, data) {
            step.className = `test-step ${status}`;
            const icon = step.querySelector('.status-icon');
            
            if (status === 'running') {
                icon.className = 'status-icon status-running';
                icon.textContent = '‚è≥';
            } else if (status === 'success') {
                icon.className = 'status-icon status-success';
                icon.textContent = '‚úì';
                testStats.passed++;
                testStats.pending--;
            } else if (status === 'error') {
                icon.className = 'status-icon status-error';
                icon.textContent = '‚úó';
                testStats.failed++;
                testStats.pending--;
            }

            if (details) {
                let detailsDiv = step.querySelector('.test-details');
                if (!detailsDiv) {
                    detailsDiv = document.createElement('div');
                    detailsDiv.className = 'test-details';
                    step.appendChild(detailsDiv);
                }
                detailsDiv.textContent = details;
            }

            if (data) {
                let dataDiv = step.querySelector('.test-data');
                if (!dataDiv) {
                    dataDiv = document.createElement('div');
                    dataDiv.className = 'test-data';
                    step.appendChild(dataDiv);
                }
                dataDiv.textContent = JSON.stringify(data, null, 2);
            }

            updateStats();
        }

        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function testProducts() {
            const step = createTestStep('test-products', 'Buscar produtos dispon√≠veis', 'GET /api/products');
            updateTestStep(step, 'running');

            try {
                const response = await fetch(`${API_URL}/products`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const products = await response.json();
                
                if (!Array.isArray(products)) {
                    throw new Error('Resposta n√£o √© um array');
                }

                if (products.length === 0) {
                    throw new Error('Nenhum produto encontrado');
                }

                updateTestStep(step, 'success', 
                    `‚úì ${products.length} produtos encontrados no banco de dados`, 
                    products.slice(0, 3));
                
                return products;
            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function testCreateFastPlus() {
            const step = createTestStep('test-fastplus', 'Criar cadastro Fast+', 'POST /api/customers');
            updateTestStep(step, 'running');

            // Gera CPF √∫nico usando timestamp para evitar conflitos
            const uniqueSuffix = Date.now().toString().slice(-8);
            const testCpf = uniqueSuffix.padStart(11, '0');
            
            const testData = {
                cpf: testCpf,
                name: 'Teste E2E FastMarket',
                phone: '11999887766'
            };

            try {
                const response = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const fastplus = await response.json();
                
                if (!fastplus.id) {
                    throw new Error('ID n√£o retornado');
                }

                createdFastPlusId = fastplus.id;
                createdFastPlusCpf = testCpf; // Armazena o CPF gerado
                
                updateTestStep(step, 'success', 
                    `‚úì Fast+ criado com sucesso. ID: ${fastplus.id}`, 
                    fastplus);
                
                return fastplus;
            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function testQueryFastPlus() {
            const step = createTestStep('test-fastplus', 'Consultar Fast+ por CPF', 'GET /api/customers/lookup?cpfOrPhone={cpf}');
            updateTestStep(step, 'running');

            try {
                const response = await fetch(`${API_URL}/customers/lookup?cpfOrPhone=${createdFastPlusCpf}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const fastplus = await response.json();
                
                if (fastplus.cpf !== createdFastPlusCpf) {
                    throw new Error('CPF n√£o corresponde');
                }

                updateTestStep(step, 'success', 
                    `‚úì Fast+ consultado com sucesso. Pontos: ${fastplus.points}`, 
                    fastplus);
                
                return fastplus;
            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function testCreateSale(products) {
            const step = createTestStep('test-sale', 'Criar venda completa', 'POST /api/sales');
            updateTestStep(step, 'running');

            const saleData = {
                items: [
                    {
                        productId: products[0].id,
                        quantity: 2
                    },
                    {
                        productId: products[1].id,
                        quantity: 1
                    }
                ],
                customerId: createdFastPlusId,
                paymentMethod: 'pix'
            };

            try {
                const response = await fetch(`${API_URL}/sales`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(saleData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const sale = await response.json();
                
                console.log('Sale response:', sale);
                
                if (!sale) {
                    throw new Error('Resposta vazia do servidor');
                }
                
                if (!sale.id) {
                    throw new Error('ID da venda n√£o retornado. Resposta: ' + JSON.stringify(sale));
                }

                createdSaleId = sale.id;
                
                let totalFormatted = 'N/A';
                if (sale.total !== undefined && sale.total !== null) {
                    totalFormatted = typeof sale.total === 'number' ? sale.total.toFixed(2) : String(sale.total);
                }
                const pointsEarned = sale.pointsEarned || 0;
                
                updateTestStep(step, 'success', 
                    `‚úì Venda criada com sucesso. ID: ${sale.id}, Total: R$ ${totalFormatted}, Pontos: ${pointsEarned}`, 
                    sale);
                
                return sale;
            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function testGetSales() {
            const step = createTestStep('test-sale', 'Listar todas as vendas', 'GET /api/sales');
            updateTestStep(step, 'running');

            try {
                const response = await fetch(`${API_URL}/sales`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const sales = await response.json();
                
                if (!Array.isArray(sales)) {
                    throw new Error('Resposta n√£o √© um array');
                }

                const createdSale = sales.find(s => s.id === createdSaleId);
                
                if (!createdSale) {
                    throw new Error('Venda criada n√£o encontrada na listagem');
                }

                updateTestStep(step, 'success', 
                    `‚úì ${sales.length} vendas encontradas. Venda criada est√° na lista.`, 
                    sales.slice(0, 2));
                
                return sales;
            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function validateDatabaseIntegrity() {
            const step = createTestStep('test-database', 'Validar integridade dos dados', 'Verifica√ß√£o final');
            updateTestStep(step, 'running');

            try {
                // Busca a venda criada
                const saleResponse = await fetch(`${API_URL}/sales/${createdSaleId}`);
                if (!saleResponse.ok) throw new Error('Venda n√£o encontrada');
                const sale = await saleResponse.json();

                // Busca o Fast+ criado
                const fastPlusResponse = await fetch(`${API_URL}/customers/lookup?cpfOrPhone=${createdFastPlusCpf}`);
                if (!fastPlusResponse.ok) throw new Error('Fast+ n√£o encontrado');
                const fastPlus = await fastPlusResponse.json();

                // Valida√ß√µes
                const checks = [];
                
                if (sale.id === createdSaleId) {
                    checks.push('‚úì Venda persistida no banco');
                } else {
                    throw new Error('ID da venda n√£o corresponde');
                }

                if (sale.items && sale.items.length === 2) {
                    checks.push('‚úì Itens da venda salvos corretamente');
                } else {
                    throw new Error('Itens da venda incompletos');
                }

                if (fastPlus.id === createdFastPlusId) {
                    checks.push('‚úì Fast+ persistido no banco');
                } else {
                    throw new Error('ID do Fast+ n√£o corresponde');
                }

                if (fastPlus.points > 0) {
                    checks.push(`‚úì Pontos acumulados: ${fastPlus.points}`);
                } else {
                    checks.push('‚ö† Pontos n√£o acumulados (pode ser normal)');
                }

                updateTestStep(step, 'success', 
                    checks.join('\n'), 
                    { sale, fastPlus });

            } catch (error) {
                updateTestStep(step, 'error', `‚úó Erro: ${error.message}`);
                throw error;
            }
        }

        async function runAllTests() {
            const button = document.getElementById('runTests');
            button.disabled = true;
            button.textContent = '‚è≥ Executando testes...';

            // Reset stats
            testStats = { total: 0, passed: 0, failed: 0, pending: 0 };
            updateStats();

            // Clear previous results
            document.getElementById('test-products').innerHTML = '';
            document.getElementById('test-fastplus').innerHTML = '';
            document.getElementById('test-sale').innerHTML = '';
            document.getElementById('test-database').innerHTML = '';

            try {
                // Teste 1: Produtos
                await sleep(500);
                const products = await testProducts();
                await sleep(500);

                // Teste 2: Fast+ (Cadastro + Consulta)
                await testCreateFastPlus();
                await sleep(500);
                await testQueryFastPlus();
                await sleep(500);

                // Teste 3: Venda
                await testCreateSale(products);
                await sleep(500);
                await testGetSales();
                await sleep(500);

                // Teste 4: Valida√ß√£o de Integridade
                await validateDatabaseIntegrity();

                button.textContent = '‚úÖ Testes Conclu√≠dos!';
                button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';

            } catch (error) {
                console.error('Erro nos testes:', error);
                button.textContent = '‚ùå Testes Falharam';
                button.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            } finally {
                setTimeout(() => {
                    button.disabled = false;
                    button.textContent = '‚ñ∂Ô∏è Executar Testes E2E Novamente';
                    button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }, 3000);
            }
        }

        // Auto-update stats on load
        updateStats();
    </script>
</body>
</html>
